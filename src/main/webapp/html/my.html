<!DOCTYPE html>
<html lang="en">
<head>
    <title>RPG</title>
    <script src=https://code.jquery.com/jquery-3.6.0.min.js></script>
    <link href="/css/custom.css" rel="stylesheet">
    <style>
        .unselected-button {
            font-weight: normal;
            color: black;
        }

        .selected-button {
            font-weight: bold;
            color: red;
        }
    </style>
</head>
<body>
<h1>RPG admin panel</h1>
<h2>Accounts list:</h2>
<div>
    <label for="page-size-selector">Count per page:</label>
    <select id="page-size-selector" onchange="update_page_size(this.value)">
        <option typeof="numeric" value=3 selected="selected">3</option>
        <option typeof="numeric" value=5>5</option>
        <option typeof="numeric" value=10>10</option>
        <option typeof="numeric" value=20>20</option>
    </select>
</div>
<table id="admin-table">
    <thead>
    <tr>
        <th>#</th>
        <th>Name</th>
        <th>Title</th>
        <th>Race</th>
        <th>Profession</th>
        <th>Level</th>
        <th>Birthday</th>
        <th>Banned</th>
        <th>Edit</th>
        <th>Delete</th>
    </tr>
    </thead>
</table>
<div id="pages">Pages:</div>
<script>
    let players_count = get_players_count()
    let page_size = get_page_size()
    let pages = get_pages()
    let last_visited_page = 0

    function update_page_size(new_page_size) {
        page_size = new_page_size
        pages = get_pages();
        updateTable(last_visited_page);
        generateButtons(document.getElementById('pages'))
        markCurrentPageButton(last_visited_page)
    }

    function get_page_size() {
        return parseInt(document.getElementById("page-size-selector").value);
    }

    function get_pages() {
        return Math.ceil(players_count / page_size)
    }

    function removeOldTable() {
        const table = document.getElementById("admin-table");
        let elementsByTagName = table.getElementsByTagName("tbody");
        if (elementsByTagName.length > 0) {
            table.removeChild(elementsByTagName[0]);
        }
    }

    function markCurrentPageButton(page_number) {
        let should_update_table = false
        const previous_button = document.getElementById("button-" + last_visited_page);
        if (previous_button != null) {
            previous_button.classList.remove('selected-button')
        } else {
            should_update_table = true
            last_visited_page--
            page_number--
        }
        if (last_visited_page > pages) {
            page_number = pages - 1
        }
        document.getElementById("button-" + page_number).classList.add('selected-button')
        last_visited_page = page_number
        if (should_update_table) {
            updateTable(page_number)
        }
        return page_number
    }

    function updateTable(page_number) {
        page_number = markCurrentPageButton(page_number);
        removeOldTable();
        putDataToTable(page_number);
    }

    function generateButtons(context) {
        const div = document.getElementById("pages");
        div.innerHTML = 'Pages:';
        for (let i = 0; i < pages; i++) {
            const button = document.createElement("input");
            button.id = "button-" + i;
            button.type = "button";
            button.value = i + '';
            button.onclick = function () {
                updateTable(i)
            }
            context.appendChild(button);
        }
    }

    $(function () {
        generateButtons(document.getElementById('pages'))
        updateTable(0);
    });

    function get_players_count() {
        let players_count
        $.ajax({
            type: "GET",
            url: "/rest/players/count",
            success: function (data) {
                players_count = data
            },
            async: false
        });
        return players_count
    }

    function editUser() {
        const id_number = this.id.slice(this.id.indexOf('-') + 1)
        const row = document.getElementById('row-' + id_number)

        if (row.cells[1].firstElementChild === null) {
            function create_input_field(cell) {
                const input = document.createElement("input")
                input.type = "text"
                input.value = cell.innerText
                return input
            }

            const name_cell = row.cells[1]
            const name_input = create_input_field(name_cell)
            name_cell.innerHTML = ''
            name_cell.appendChild(name_input)

            const title_cell = row.cells[2]
            const title_input = create_input_field(title_cell)
            title_cell.innerHTML = ''
            title_cell.appendChild(title_input)

            function create_selector(cell, values) {
                const selector = document.createElement("select")
                values.map(function (value) {
                    const option = document.createElement("option");
                    option.value = value;
                    option.innerHTML = value;
                    selector.appendChild(option);
                    if (option.value === cell.innerText) {
                        option.selected = true
                    }
                })
                return selector
            }

            const race_cell = row.cells[3]
            const race_selector = create_selector(race_cell, ['HUMAN', 'DWARF', 'ELF', 'GIANT', 'ORC', 'TROLL', 'HOBBIT'])
            race_cell.innerHTML = ''
            race_cell.appendChild(race_selector)

            const profession_cell = row.cells[4]
            const profession_selector = create_selector(profession_cell, ['WARRIOR', 'ROGUE', 'SORCERER', 'CLERIC', 'PALADIN', 'NAZGUL', 'WARLOCK', 'DRUID'])
            profession_cell.innerHTML = ''
            profession_cell.appendChild(profession_selector)

            const banned_cell = row.cells[7]
            const banned_selector = create_selector(banned_cell, ['true', 'false'])
            banned_cell.innerHTML = ''
            banned_cell.appendChild(banned_selector)

            const image = row.cells[8].firstChild
            image.src = '/img/save.png'
        } else {
            alert(JSON.stringify({
                name: row.cells[1].firstElementChild.value,
                title: row.cells[2].firstElementChild.value
            }))
            $.ajax({
                type: "POST",
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({
                    name: row.cells[1].firstElementChild.value,
                    title: row.cells[2].firstElementChild.value
                    // "race": JSON.stringify(row.cells[3].firstElementChild.value),
                    // "profession": JSON.stringify(row.cells[4].firstElementChild.value),
                    // "banned": JSON.stringify(row.cells[7].firstElementChild.value),
                }),
                url: `/rest/players/${id_number}`,
                async: false
            });
        }
    }

    function postUser() {

    }

    function deleteUser() {
        $.ajax({
            type: "DELETE",
            url: `/rest/players/${this.id}`,
            async: false
        });
        players_count = get_players_count();
        pages = get_pages()
        updateTable(last_visited_page);
        generateButtons(document.getElementById('pages'))

        //TODO: fix bug. To reproduce it, subsequently remove users from the end - you will see wrongly rendered table
        markCurrentPageButton(last_visited_page)
    }

    function putDataToTable(page_number) {
        $.getJSON('/rest/players', {pageNumber: page_number, pageSize: page_size}, function (data) {
            const tbody = document.createElement("tbody");
            $.each(data, function () {
                const tr = tbody.insertRow();
                tr.id = 'row-' + this.id

                const data = [this.id, this.name, this.title, this.race, this.profession, this.level, this.birthday, this.banned];
                data.map(function (text) {
                    tr.insertCell().appendChild(document.createTextNode(text));
                })

                function construct_image(id, src, onclick) {
                    const img = document.createElement('img')
                    img.id = id
                    img.src = src
                    img.onclick = onclick
                    img.style.cursor = "pointer";
                    return img
                }

                tr.insertCell().appendChild(construct_image(`edit-${this.id}`, "/img/edit.png", editUser));
                tr.insertCell().appendChild(construct_image(`delete-${this.id}`, "/img/delete.png", deleteUser));
            });
            $("#admin-table").append(tbody);
        });
    }
</script>
</body>
</html>